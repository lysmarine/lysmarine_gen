---
version: 2.1
orbs:
  cloudsmith: cloudsmith/cloudsmith@1.0.4

executors:
  boot-linux:
    machine:
      enabled: true
      image: ubuntu-1604:202010-01

commands:
  publish:
    steps:
      - cloudsmith/ensure-api-key
      - cloudsmith/install-cli
      - run: .circleci/publish-cloudsmith.sh img lysmarineos/images ${PKG_DISTRO}/${PKG_RELEASE}

  build-lysmarine:
    steps:
      - run: sudo apt-get -y install wget
      - run: chmod a+x .circleci/*.sh
      - run:
          command: |
            .circleci/build-ci.sh
          no_output_timeout: 30m

jobs:
  build-on-buster-arm32:
    executor: boot-linux
    environment:
      - DOCKER_IMAGE=arm32v7/debian:buster
      - CONTAINER_DISTRO=debian:buster
      - PKG_RELEASE=raspbian
      - PKG_DISTRO=buster
      - PKG_ARCH=armhf
      - EMU=on
    steps:
      - checkout
      - build-lysmarine
  build-on-buster-arm64:
    executor: boot-linux
    environment:
      - DOCKER_IMAGE=arm64v8/debian:buster
      - CONTAINER_DISTRO=debian:buster
      - PKG_RELEASE=raspbian
      - PKG_DISTRO=buster
      - PKG_ARCH=arm64
      - EMU=on
    steps:
      - checkout
      - build-lysmarine

workflows:
  version: 2
  build_all:
    jobs:
      - build-on-buster-arm32
      - build-on-buster-arm64
      - hold
      - publish