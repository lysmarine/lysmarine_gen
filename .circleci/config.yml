---
version: 2.1
orbs:
  cloudsmith: cloudsmith/cloudsmith@1.0.4

executors:
  linux:
    machine:
      image: ubuntu-2004:202010-01
    resource_class: medium


jobs:
  raspios-arm32:
    executor: linux
    environment:
      - PKG_RELEASE=raspios
      - PKG_DISTRO=buster
      - PKG_ARCH=armhf
      - LYSMARINE_VER=0.9.0.10
    steps:
      - checkout
      - run: sudo apt-get -q update
      - run: sudo apt-get -y -q install dpkg-dev debhelper devscripts equivs pkg-config apt-utils fakeroot git-core live-build kpartx p7zip p7zip-full parted e2fsprogs qemu-user
      - run: cd ci-source/cross-build-release; sudo chmod -v u+w *.sh; sudo /bin/bash -xe ./raspbian.sh $PKG_ARCH $LYSMARINE_VER"

  publish:
    executor: cloudsmith/default
    steps:
      - checkout
      - cloudsmith/ensure-api-key
      - cloudsmith/install-cli
      - run: .circleci/publish-cloudsmith.sh img lysmarineos/images ${PKG_DISTRO}/${PKG_RELEASE}

workflows:
  version: 2
  build_all:
    jobs:
      - raspios-arm32
      - publish:
          requires:
            - raspios-arm32
