---
version: 2.1

orbs:
  cloudsmith: cloudsmith/cloudsmith@1.0.4

executors:
  linux:
    machine:
      image: ubuntu-2004:202010-01
    resource_class: medium

commands:
  prepare-linux-machine:
    description: "Install the requirements to run lysmarine build script"
    steps:
      - checkout
      - run: sudo apt-get -q update
      - run: sudo apt-get -y -q install proot qemu qemu-user git p7zip-full
      - run: wget http://http.us.debian.org/debian/pool/main/l/live-build/live-build_20190311_all.deb
      - run: sudo apt install ./live-build_20190311_all.deb
      - run: cd cross-build-release; sudo chmod -v u+w *.sh;



jobs:
  build-raspios-arm32:
    executor: linux
    environment:
      - PKG_DISTRO=buster
      - LYSMARINE_VER=0.9.0.10
      - PKG_RELEASE=raspios
      - PKG_ARCH=armhf
    steps:
      - prepare-linux-machine
      - attach_workspace:
          at: /home/circleci
      - run:
          #command: cd cross-build-release;sudo /bin/bash -xe ./raspbian.sh $PKG_ARCH $LYSMARINE_VER
          command: mkdir -p ./cross-build-release/release/raspios/ ;cd ./cross-build-release/release/raspios/;echo test > raspios-arm32-dummy.img
          no_output_timeout: 30m
      - persist_to_workspace:
          root: .
          paths: ./cross-build-release/release/raspios/
      - store_artifacts:
          path: ./cross-build-release/release/raspios/
          destination: release/

  build-raspios-arm64:
    executor: linux
    environment:
      - PKG_DISTRO=buster
      - LYSMARINE_VER=0.9.0.10
      - PKG_RELEASE=raspios
      - PKG_ARCH=arm64
    steps:
      - prepare-linux-machine
      - attach_workspace:
          at: /home/circleci
      - run:
          #command: cd cross-build-release; sudo /bin/bash -xe ./raspbian.sh $PKG_ARCH $LYSMARINE_VER
          command: mkdir -p ./cross-build-release/release/raspios/ ;cd ./cross-build-release/release/raspios/;echo test > raspios-arm64-dummy.img
          no_output_timeout: 30m
      - persist_to_workspace:
           root: .
           paths: ./cross-build-release/release/raspios/
      - store_artifacts:
          path: ./cross-build-release/release/raspios/
          destination: release/

  build-armbian-pine64so:
    executor: linux
    environment:
      - PKG_DISTRO=buster
      - LYSMARINE_VER=0.9.0.10
      - PKG_RELEASE=armbian-pineA64
      - PKG_ARCH=armbian-pineA64
    steps:
      - attach_workspace:
          at: /home/circleci
      - run:
          #command: cd cross-build-release; sudo /bin/bash -xe ./armbian-pine64so.sh $PKG_ARCH $LYSMARINE_VER
          command: mkdir -p ./cross-build-release/release/raspios/ ; cd ./cross-build-release/release/raspios/;echo test > raspios-pine64-dummy.img
          no_output_timeout: 30m
      - store_artifacts:
          path: ./cross-build-release/release/pineA64/*
          destination: release/$PKG_ARCH/

  build-debian-live:
    executor: linux
    environment:
      - PKG_DISTRO=buster
      - LYSMARINE_VER=0.9.0.10
      - PKG_ARCH=amd64
    steps:
      - prepare-linux-machine
      - run: lb -v
      - run:
          command: cd cross-build-release; sudo /bin/bash -xe ./debian-live.sh
          no_output_timeout: 30m
      - store_artifacts:
          path: ./cross-build-release/release/amd64/*
          destination: release/$PKG_ARCH/

  build-debian-vbox:
    executor: linux
    environment:
      - PKG_DISTRO=buster
      - LYSMARINE_VER=0.9.0.10
      - PKG_ARCH=amd64
    steps:
      - prepare-linux-machine
      - run: sudo apt-get install virtualbox
      #- run: cd cross-build-release; sudo /bin/bash -xe ./debian-vbox.sh
      - store_artifacts:
          path: ./cross-build-release/release/amd64/*
          destination: release/$PKG_ARCH/

  publish:
    executor: cloudsmith/default
    steps:
      - attach_workspace:
          at: ./cross-build-release/release/raspios/
      - cloudsmith/ensure-api-key
      - cloudsmith/install-cli
      - run: pwd; ls -lah
      - run: ls -lah ./cross-build-release/release/
      - cloudsmith/publish:
          cloudsmith-repository: lysmarineos/images
          package-format: img
          package-path: ./cross-build-release/release/*



workflows:
  version: 2
  build_all:
    jobs:
      - build-raspios-arm32
      - build-raspios-arm64
      #- build-debian-vbox
      # - build-armbian-pine64so
      # - build-debian-live
      - publish:
          requires:
            - build-raspios-arm32
            - build-raspios-arm64
      # filters:
       # branches:
        #  only: master