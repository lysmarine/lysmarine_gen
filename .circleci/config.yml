---
version: 2.1

orbs:
  cloudsmith: cloudsmith/cloudsmith@1.0.4

executors:
  linux:
    machine:
      image: ubuntu-2004:202010-01
      
commands:
  prepare-linux-machine:
    description: "Install the requirements to run lysmarine build script"
    steps:
      - checkout
      - run: sudo apt-get -q update
      - run: sudo apt-get -y -q install proot qemu qemu-user git p7zip-full parted kpartx
      - run: cd cross-build-release; sudo chmod -v u+w *.sh;

  publish:
    steps:
      - cloudsmith/ensure-api-key
      - cloudsmith/install-cli
      - run: ls -lah ./cross-build-release/release/
      - run: zip $(ls ./cross-build-release/release/).zip ./cross-build-release/release/$(ls ./cross-build-release/release/)
      - cloudsmith/publish:
          cloudsmith-repository: lysmarineos/images
          package-format: raw
          package-path: ./*.zip

jobs:
  build-on-linux:
    executor: linux
    parameters:
      baseOs:
        type: string
      cpuArch:
        type: string
      version:
        type: string
      stage:
        type: string
    steps:
      - prepare-linux-machine
      - run:
          command: cd cross-build-release; sudo ./build.sh <<parameters.baseOs>> <<parameters.cpuArch>> <<parameters.version>> "<<parameters.stage>>"
          no_output_timeout: 30m
      - publish



workflows:
  version: 2
  build_all:
    jobs:
      - build-on-linux:
          baseOs: 'raspios'
          cpuArch: 'armhf'
          version: 'dev'
          stage: '0 2 4 6 8 '

      - build-on-linux:
          baseOs: 'raspios'
          cpuArch: 'arm64'
          version: 'dev'
          stage: '0 2 4'

      - build-on-linux:
          baseOs: 'debian-live'
          cpuArch: 'amd64'
          version: 'dev'
          stage: '0 2 4'

      - build-on-linux:
          baseOs: 'raspbian'
          cpuArch: 'pine64so'
          version: 'dev'
          stage: '0 2 4'

      - build-on-linux:
          baseOs: 'debian-vbox'
          cpuArch: 'amd64'
          version: 'dev'
          stage: '0 2 4'
